<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1"
  />
  <title> Clicker + Slots + Mines + Goals + Accounts + Admin + Transfers</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Bungee&family=Poppins:wght@300;500;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root{
      --bg: #0f1720;
      --panel: rgba(255,255,255,0.04);
      --panel-solid: #0b1218;
      --accent: #ffd43b;
      --text: #cfe6ff;
      --muted: #8fa9cb;
      --btn: #22272b;
      --btn-h: #3a4248;
      --ok: #36d399;
      --warn: #ff8f4f;
      --danger: #ff5050;
      --good-1: #28a745;
      --good-2: #218838;
      --card-br: 12px;
      --font: 'Poppins', system-ui, Segoe UI, Roboto, Arial, sans-serif;
      --display: 'Bungee', cursive;
      --ring: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      min-height:100vh;
      background:
        radial-gradient(1200px 500px at 10% 10%, rgba(255,215,0,0.05), transparent 10%),
        radial-gradient(800px 400px at 90% 80%, rgba(0,200,255,0.03), transparent 10%),
        linear-gradient(180deg, var(--bg), #07090e 60%);
      color:var(--text);
      font-family:var(--font);
      display:flex;
      justify-content:center;
      padding:18px;
    }
    .container{
      width: 440px;
      max-width: 96vw;
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.07);
      border-radius: var(--card-br);
      box-shadow: 0 12px 40px rgba(0,0,0,.65);
      padding: 16px;
      display:flex;
      flex-direction:column;
      gap: 14px;
      position:relative;
      overflow:hidden;
    }

    /* --- HEADER --- */
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position:relative;
      z-index: 3;
    }
    .header-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      flex:1 1 auto;
    }
    .header-right{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      flex:0 0 auto;
    }
    h1{
      font-family:var(--display);
      color:var(--accent);
      margin:0;
      font-size:1.9rem;
      letter-spacing:.5px;
      text-shadow:0 6px 24px rgba(0,0,0,.6);
      user-select:none;
      white-space:nowrap;
    }

    /* MENU (far left) */
    .hamburger{ position:relative; z-index: 4; }
    .hamburger button{
      display:flex; align-items:center; gap:8px;
      background: var(--btn); color:var(--text);
      border:none; border-radius:10px; padding:8px 10px;
      cursor:pointer; user-select:none;
      box-shadow: 0 6px 20px rgba(0,0,0,.3);
      white-space:nowrap;
    }
    .hamburger button:hover{ background:var(--btn-h); }
    .hamburger .icon{ width:18px; height:12px; position:relative; }
    .hamburger .icon::before,
    .hamburger .icon::after,
    .hamburger .icon span{
      content:""; position:absolute; left:0; right:0; height:2px;
      background:var(--text); border-radius:2px;
    }
    .hamburger .icon::before{ top:0 }
    .hamburger .icon span{ top:5px }
    .hamburger .icon::after{ bottom:0 }

    /* Dropdown opens BELOW the button, left-aligned so it doesn't cover balance */
    .dropdown{
      position:absolute; top:42px; left:0;
      min-width:210px;
      background: var(--panel-solid);
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      overflow:hidden;
      display:none;
      z-index:50;
    }
    .dropdown.show{ display:block }
    .dropdown .group-title{
      padding:8px 12px; font-weight:900; color:var(--muted);
      border-bottom:1px solid rgba(255,255,255,.06);
      background: #0a1016;
    }
    .dropdown button{
      width:100%; text-align:left; padding:10px 12px;
      background:transparent; color:var(--text); border:none;
      font-weight:700; cursor:pointer; font-size:.95rem;
      display:flex; align-items:center; justify-content:space-between;
    }
    .dropdown button:hover{ background: rgba(255,255,255,.06); }

    /* BALANCE sits right of the menu and is always visible */
    .balance{
      text-align:left;
      font-size:.95rem;
      color:var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1 1 auto;
      min-width:0;
    }
    .balance b{
      display:block;
      font-size:1.45rem;
      color:var(--text);
      line-height:1.05;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Tabs */
    nav.tabs{
      display:flex; gap:8px;
      border-bottom:1px solid rgba(255,255,255,.08);
      position:sticky; top:0; background:linear-gradient(180deg, rgba(11,18,24,.9), rgba(11,18,24,.8));
      z-index:2; padding-top:2px;
      backdrop-filter: blur(0px);
    }
    nav.tabs button{
      flex:1; background:var(--btn); color:var(--muted);
      border:none; padding:10px 0; border-radius:10px 10px 0 0;
      font-weight:700; cursor:pointer; user-select:none;
    }
    nav.tabs button.active{
      background:var(--accent); color:#0b1218;
      box-shadow:0 8px 24px rgba(0,0,0,.35);
    }

    /* Sections */
    section[role="tabpanel"]{ display:none; }
    section[role="tabpanel"].active{ display:block; }

    /* Clicker */
    #clicker-section{ display:flex; flex-direction:column; gap:10px; user-select:none; }
    #money-bag{
      margin: 16px auto 10px;
      width: 150px; height:150px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      font-size:74px; cursor:pointer;
      background: radial-gradient(circle at 30% 30%, #444, #222 70%);
      box-shadow:
        inset 0 10px 22px rgba(255,215,0,.55),
        0 10px 28px rgba(255,208,0,.35);
      color:#ffd45a;
      transition: transform .08s ease, box-shadow .2s ease;
      outline: none;
      position:relative;
    }
    #money-bag:hover{ transform:scale(1.05); box-shadow: inset 0 12px 26px rgba(255,215,0,.65), 0 12px 30px rgba(255,208,0,.55) }
    #money-bag:active{ transform: scale(0.97); }
    #cps-indicator{
      position:absolute; bottom:-16px; left:50%; transform:translateX(-50%);
      font-size:.78rem; color:var(--muted);
    }
    #coins-info{ font-weight:700; text-align:center; }
    #cpc-info{ text-align:center; color:var(--muted) }

    /* Upgrades list — taller + scroll all the way down */
    #upgrades{
      display:flex; flex-direction:column; gap:8px;
      max-height:60vh;           /* ensure full scrolling */
      overflow:auto; padding-right:6px;
      overscroll-behavior:contain;
    }
    #upgrades::-webkit-scrollbar{ width:8px }
    #upgrades::-webkit-scrollbar-thumb{ background:var(--accent); border-radius:6px }
    .upgrade{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:var(--btn); border-radius:10px; padding:10px 12px; cursor:pointer;
      border: 1px solid rgba(255,255,255,.06);
    }
    .upgrade:hover:not(.disabled){ background:var(--btn-h) }
    .upgrade.disabled{ opacity:.55; cursor:not-allowed }
    .upgrade .name{ font-weight:800 }
    .upgrade .info{ color:var(--muted); font-size:.85rem; text-align:center; flex:1 }
    .upgrade .cost{ color:var(--accent); font-weight:800; min-width:120px; text-align:right }

    /* Rebirth */
    #rebirth-wrap{ padding-top:8px; }
    #rebirth-btn{
      margin-top:8px; padding:12px 14px; width:100%;
      font-weight:900; font-size:1rem; border:none; border-radius:10px; color:#fff;
      background: linear-gradient(180deg, var(--good-1), var(--good-2));
      cursor:pointer; user-select:none;
      box-shadow: 0 3px 0 rgba(0,0,0,.22);
    }
    #rebirth-btn:disabled{ filter: grayscale(80%); opacity:.6; cursor:not-allowed; }
    #rebirth-need{ text-align:center; color:var(--muted); font-size:.9rem; margin-top:2px; }

    /* Gambling */
    #gambling-section{ display:flex; flex-direction:column; gap:12px; }
    .gambling-tabs{ display:flex; gap:8px; }
    .gambling-tabs button{
      flex:1; border:none; border-radius:10px; background:var(--btn);
      color:var(--muted); font-weight:800; padding:8px 0; cursor:pointer;
    }
    .gambling-tabs button.active{ background:var(--accent); color:#0b1218 }

    /* Slot */
    #slot-machine{ display:flex; flex-direction:column; align-items:center; gap:10px; }
    #slot-bet{ width:100%; background:var(--btn); color:var(--text); border:none; border-radius:10px; padding:10px; text-align:center; }
    #slot-spin{ padding:10px 12px; border:none; border-radius:10px; color:#fff; background:linear-gradient(180deg,var(--good-1),var(--good-2)); font-weight:900; cursor:pointer; }
    #slot-spin:disabled{ filter:grayscale(90%); opacity:.6; cursor:not-allowed; }
    #slot-reels{
      font-size:54px; letter-spacing:18px; user-select:none;
      display:block; text-align:center; line-height:1;
      width:100%;
    }
    #slot-msg{ min-height:28px; color:var(--accent); font-weight:800; text-align:center; width:100%; }

    /* Mines */
    #mines{ display:flex; flex-direction:column; gap:10px; }
    .row{ display:flex; gap:8px; align-items:center; }
    .row .input{ flex:1; background:var(--btn); color:var(--text); border:none; border-radius:10px; padding:10px; text-align:center; }
    .row .btn{ background:var(--btn); color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:10px; padding:10px; cursor:pointer; font-weight:800; }
    .row .btn.go{ background:linear-gradient(180deg,var(--good-1),var(--good-2)); color:#fff; border:none; }
    .row .btn:disabled{ filter:grayscale(90%); opacity:.6; cursor:not-allowed; }
    #mines-grid{ display:grid; grid-template-columns: repeat(5, 52px); gap:8px; justify-content:center; }
    .mines-cell{
      width:52px; height:52px; border-radius:10px; background:var(--btn);
      display:flex; align-items:center; justify-content:center; cursor:pointer;
      font-size:26px; border:2px solid transparent; font-weight:900; color:var(--text);
      user-select:none;
    }
    .mines-cell:hover:not(.revealed){ background:var(--btn-h); }
    .mines-cell.revealed.safe{ background:#ffd43b; color:#402b00 }
    .mines-cell.revealed.bomb{ background:var(--danger); color:#320000 }
    #mines-stats{ text-align:center; color:var(--muted) }
    #mines-stats b{ color:var(--accent) }

    /* Goals */
    #goals{ display:flex; flex-direction:column; gap:10px; }
    .goal-mult-row{
      display:grid; gap:6px; justify-content:center; align-content:center;
    }
    .goal-mult{
      min-width:48px; height:24px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      padding:0 6px; font-size:.78rem; font-weight:900;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      color:var(--muted);
      user-select:none;
    }
    .goal-mult.active{
      outline:2px solid var(--accent); color:#0b1218; background:var(--accent);
    }

    #goals-grid-wrap{
      display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:center;
    }
    #goals-grid{ display:grid; gap:6px; justify-content:center; }
    .goal{
      width:48px; height:48px; border-radius:10px; background:var(--btn);
      display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:24px; font-weight:900;
      user-select:none; color:var(--text);
    }
    .goal:hover:not(.revealed){ background:var(--btn-h) }
    .goal.revealed.safe{ background:#ffd43b; color:#402b00 }
    .goal.revealed.bomb{ background:var(--danger); color:#320000 }
    #goals-stat{ text-align:center; color:var(--muted) }
    #goals-stat b{ color:var(--accent) }

    /* Info */
    #info-section{ color:var(--muted) }
    #info-section .secret{ display:none } /* never reveal admin password */

    /* Account */
    #account-section{ display:flex; flex-direction:column; gap:12px; }
    .card{
      background: rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:10px;
      display:flex; flex-direction:column; gap:8px;
    }
    .acct-tabs{ display:flex; gap:8px; }
    .acct-tabs .tab{ flex:1; border:none; background:var(--btn); color:var(--muted); border-radius:10px; padding:8px; font-weight:900; cursor:pointer; }
    .acct-tabs .tab.active{ background:var(--accent); color:#0b1218 }
    .form{ display:flex; flex-direction:column; gap:8px; }
    .input{ background:var(--btn); color:var(--text); border:none; border-radius:10px; padding:10px; }
    .btn{ background:var(--accent); color:#0b1218; border:none; border-radius:10px; padding:10px; font-weight:900; cursor:pointer; }
    .btn.text{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,.08); }
    .muted{ color:var(--muted); font-size:.9rem; }

    /* Panels (modal) */
    .panel{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.58); z-index:999;
    }
    .panel.show{ display:flex }
    .panel .card{ width:440px; max-width:96vw; }
    .panel h3{ margin:0; color:var(--accent); font-size:1.2rem; }

    /* Toast */
    #toast{
      position:fixed; top:18px; right:18px; background: rgba(0,0,0,.78);
      color:#fff; padding:10px 14px; border-radius:12px; font-weight:900;
      opacity:0; transform: translateY(-18px);
      transition: opacity .25s, transform .25s;
      z-index:9999; pointer-events:none; user-select:none;
    }
    #toast.show{ opacity:1; transform: translateY(0) }

    #footer{ text-align:right; color:var(--muted); font-size:10px; font-style:italic; user-select:none; }

    @media (max-width:480px){
      .container{ width:96vw; padding:12px }
      #slot-reels{ font-size:44px; letter-spacing:12px }
      #money-bag{ width:130px; height:130px; font-size:62px }
      .upgrade .cost{ min-width:96px }
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-label="Make Money Co">
    <header>
      <!-- LEFT SIDE: menu then balance (so it never covers the amount) -->
      <div class="header-left">
        <div class="hamburger" aria-label="Menu">
          <button id="menu-btn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="menu-dropdown" title="Menu">
            <span class="icon"><span></span></span>
            <span style="font-weight:900; font-size:.9rem; color:var(--muted)">Menu</span>
          </button>
          <div id="menu-dropdown" class="dropdown" role="menu" aria-hidden="true">
            <div class="group-title">Quick Actions</div>
            <button id="menu-leaderboard" role="menuitem">Leaderboard</button>
            <button id="menu-admin" role="menuitem">Admin</button>
            <button id="menu-money" role="menuitem">Money</button>
          </div>
        </div>

        <div class="balance" aria-live="polite">
          <span>Bank</span>
          <b>$<span id="balance">0.00</span></b>
        </div>
      </div>

      <!-- RIGHT: keep the original title aesthetic -->
      <div class="header-right">
        <h1>Make Money Co</h1>
      </div>
    </header>

    <nav class="tabs" role="tablist" aria-label="Sections">
      <button id="tab-clicker" class="active" role="tab" aria-selected="true" aria-controls="clicker-section">Clicker</button>
      <button id="tab-gambling" role="tab" aria-selected="false" aria-controls="gambling-section">Gambling</button>
      <button id="tab-info" role="tab" aria-selected="false" aria-controls="info-section">Info</button>
      <button id="tab-account" role="tab" aria-selected="false" aria-controls="account-section">Account</button>
    </nav>

    <!-- CLICKER -->
    <section id="clicker-section" class="active" role="tabpanel" aria-labelledby="tab-clicker">
      <div id="money-bag" tabindex="0" role="button" aria-label="Click to earn coins">💰
        <div id="cps-indicator" aria-hidden="true">0/10 cps</div>
      </div>
      <div id="coins-info">Coins Earned: <b><span id="coins">0.00</span></b></div>
      <div id="cpc-info">Coins Per Click: <b><span id="cpc">0.05</span></b></div>

      <div id="upgrades" aria-label="Upgrades list"></div>

      <div id="rebirth-wrap">
        <button id="rebirth-btn" disabled aria-disabled="true" title="Rebirth to multiply your CPC">
          Rebirth
        </button>
        <div id="rebirth-need">Requires: $<span id="rebirth-cost">100,000,000,000</span></div>
      </div>
    </section>

    <!-- GAMBLING -->
    <section id="gambling-section" role="tabpanel" aria-labelledby="tab-gambling" aria-hidden="true" style="display:none">
      <div class="gambling-tabs" role="tablist">
        <button id="gt-slot" class="active" role="tab" aria-selected="true" aria-controls="slot-machine">Slot Machine</button>
        <button id="gt-mines" role="tab" aria-selected="false" aria-controls="mines">Mines</button>
        <button id="gt-goals" role="tab" aria-selected="false" aria-controls="goals">Goals</button>
      </div>

      <!-- Slot Machine -->
      <div id="slot-machine" role="tabpanel" aria-labelledby="gt-slot" style="display:block">
        <input id="slot-bet" class="input" type="number" min="50" step="1" value="50" aria-label="Slot bet amount" />
        <button id="slot-spin" class="btn go">Spin 🎰</button>
        <div id="slot-reels" aria-live="polite" aria-atomic="true">🍒 🍋 🍉</div>
        <div id="slot-msg" aria-live="polite" aria-atomic="true"></div>
      </div>

      <!-- Mines -->
      <div id="mines" role="tabpanel" aria-labelledby="gt-mines" style="display:none">
        <div class="row">
          <input id="mines-bet" class="input" type="number" min="1" step="1" value="10" aria-label="Mines bet" />
          <select id="mines-bombs" class="input" aria-label="Mines count">
            <option value="1">1 Bomb</option>
            <option value="2">2 Bombs</option>
            <option value="3">3 Bombs</option>
          </select>
        </div>
        <div class="row">
          <button id="mines-start" class="btn go">Start</button>
          <button id="mines-cashout" class="btn" disabled>Cash Out</button>
        </div>
        <div id="mines-grid" role="grid" aria-readonly="true"></div>
        <div id="mines-stats">Gems: <b id="mines-gems">0</b> &nbsp;|&nbsp; Mult: <b id="mines-mult">1.00x</b> &nbsp;|&nbsp; Potential: $<b id="mines-pot">0.00</b></div>
      </div>

      <!-- Goals -->
      <div id="goals" role="tabpanel" aria-labelledby="gt-goals" style="display:none">
        <div class="row">
          <input id="goals-bet" class="input" type="number" min="1" step="1" value="10" aria-label="Goals bet" />
          <select id="goals-size" class="input" aria-label="Goals grid size">
            <option value="7x4" selected>7 × 4</option>
            <option value="10x5">10 × 5</option>
          </select>
        </div>
        <div class="row">
          <button id="goals-start" class="btn go">Start</button>
          <button id="goals-cashout" class="btn" disabled>Cash Out</button>
        </div>

        <div id="goals-grid-wrap">
          <div class="goal-mult-row" id="goals-mult-row"></div>
          <div id="goals-grid" role="grid" aria-readonly="true"></div>
        </div>

        <div id="goals-stat">Column: <b id="goals-col">—</b> &nbsp;|&nbsp; Cash Mult: <b id="goals-mult">—</b> &nbsp;|&nbsp; Potential: $<b id="goals-pot">0.00</b></div>
      </div>
    </section>

    <!-- INFO -->
    <section id="info-section" role="tabpanel" aria-labelledby="tab-info" aria-hidden="true" style="display:none">
      <p><strong>Make Money Co</strong> — created by Koby Webster.</p>
      <p>Click to earn coins, buy upgrades, rebirth for growth, play Slots, Mines, and Goals to multiply your bank.</p>
      <p><em>Note:</em> Accounts save to your browser using localStorage. The Admin panel is passcode-protected.</p>
      <hr />
      <p><strong>Rebirth:</strong> The cost increases by <strong>×100</strong> each time you rebirth. Reach the cost to rebirth and permanently buff your CPC.</p>
      <div class="secret">Admin pass hint is hidden.</div>
    </section>

    <!-- ACCOUNT -->
    <section id="account-section" role="tabpanel" aria-labelledby="tab-account" aria-hidden="true" style="display:none">
      <div class="card">
        <div class="acct-tabs">
          <button id="acct-tab-login" class="tab active" type="button">Login</button>
          <button id="acct-tab-register" class="tab" type="button">Register</button>
        </div>

        <!-- Login -->
        <form id="login-form" class="form" onsubmit="return false;">
          <input id="login-user" class="input" placeholder="Username" autocomplete="username" />
          <input id="login-pass" type="password" class="input" placeholder="Password" autocomplete="current-password" />
          <button id="login-btn" class="btn" type="button">Login</button>
        </form>

        <!-- Register -->
        <form id="reg-form" class="form" onsubmit="return false;" style="display:none">
          <input id="reg-user" class="input" placeholder="Choose a username" autocomplete="username" />
          <input id="reg-pass" type="password" class="input" placeholder="Choose a password" autocomplete="new-password" />
          <input id="reg-pass2" type="password" class="input" placeholder="Confirm password" autocomplete="new-password" />
          <button id="reg-btn" class="btn" type="button">Create Account</button>
        </form>

        <div class="row">
          <button id="manual-save" class="btn" style="flex:1">Manual Save</button>
        </div>
        <div id="acct-status" class="muted">Not logged in</div>
        <div class="muted">Auto-save every 60s (localStorage)</div>
      </div>
    </section>

    <!-- PANELS -->
    <div class="panel" id="panel-leaderboard" aria-hidden="true">
      <div class="card">
        <h3>Leaderboard</h3>
        <div class="muted" style="margin-bottom:6px">Top 3 — Money</div>
        <div id="lb-money" class="card" style="max-height:160px; overflow:auto; gap:6px"></div>
        <div class="muted" style="margin-top:10px;margin-bottom:6px">Top 3 — Rebirths</div>
        <div id="lb-rebirths" class="card" style="max-height:160px; overflow:auto; gap:6px"></div>
        <div class="row" style="justify-content:flex-end; margin-top:8px">
          <button class="btn text" id="lb-refresh">Refresh</button>
          <button class="btn text" data-close="panel-leaderboard">Close</button>
        </div>
      </div>
    </div>

    <div class="panel" id="panel-admin" aria-hidden="true">
      <div class="card">
        <h3>Admin</h3>
        <div id="admin-locked">
          <div class="row">
            <input id="admin-pass" class="input" type="password" placeholder="Passcode" />
            <button id="admin-login" class="btn">Login</button>
          </div>
          <div class="muted">Passcode required.</div>
        </div>

        <div id="admin-body" style="display:none">
          <div class="row" style="justify-content:space-between">
            <div class="muted">Logged in as Admin</div>
            <button id="admin-logout" class="btn text">Logout</button>
          </div>

          <div>
            <strong style="color:var(--accent)">Accounts</strong>
            <div id="admin-accounts" class="card" style="max-height:220px; overflow:auto; gap:6px"></div>
          </div>

          <div class="row" style="margin-top:6px">
            <button id="admin-reset-all" class="btn" style="background:var(--danger); color:#fff">Reset ALL Progress</button>
            <button id="admin-refresh" class="btn text">Refresh</button>
          </div>

          <div style="margin-top:8px">
            <strong style="color:var(--accent)">Selected Account</strong>
            <div class="row">
              <input id="adm-user" class="input" placeholder="username" disabled />
              <input id="adm-balance" class="input" type="number" step="0.01" placeholder="Balance" />
            </div>
            <div class="row">
              <button id="adm-save" class="btn">Save Changes</button>
              <button id="adm-give1k" class="btn">Give +1,000</button>
              <button id="adm-wipe" class="btn" style="background:var(--danger); color:#fff">Wipe User</button>
            </div>
          </div>

          <div class="row" style="justify-content:flex-end">
            <button class="btn text" data-close="panel-admin">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="panel" id="panel-money" aria-hidden="true">
      <div class="card">
        <h3>Send Money</h3>
        <div class="row">
          <input id="money-from" class="input" disabled />
          <select id="money-to" class="input"></select>
        </div>
        <div class="row">
          <input id="money-amount" class="input" type="number" step="0.01" min="0.01" placeholder="Amount" />
        </div>
        <div class="row" style="justify-content:flex-end">
          <button id="money-send" class="btn">Send</button>
          <button class="btn text" data-close="panel-money">Close</button>
        </div>
        <div class="muted">Transfers are sent from your account only. Choose a recipient and amount.</div>
      </div>
    </div>

    <div id="toast" role="alert" aria-live="assertive" aria-atomic="true"></div>
    <div id="footer">Made by Koby Webster</div>
  </div>

  <script>
  // =========================
  // Make Money Co — All Logic (fixed)
  // =========================

  // --------- Utilities ---------
  const qs = (sel, root=document) => root.querySelector(sel);
  const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const fmt = n => Number(n).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
  const clamp = (n,min,max) => Math.max(min, Math.min(max, n));
  const numberFmt0 = n => Number(n).toLocaleString();

  const toastEl = qs('#toast');
  let toastTimer;
  function toast(msg, t=1600){
    clearTimeout(toastTimer);
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    toastTimer = setTimeout(()=>toastEl.classList.remove('show'), t);
  }

  // --------- Storage ---------
  const LS_USERS = 'mmc_users';
  const LS_SESSION = 'mmc_current_user';
  const LS_LASTSAVE = 'mmc_last_save';

  function loadUsers(){
    try{
      const raw = localStorage.getItem(LS_USERS);
      if(!raw) return {};
      const obj = JSON.parse(raw);
      return obj && typeof obj==='object' ? obj : {};
    }catch{ return {}; }
  }
  function saveUsers(uMap){
    localStorage.setItem(LS_USERS, JSON.stringify(uMap));
    localStorage.setItem(LS_LASTSAVE, Date.now().toString());
  }
  function getSession(){ return localStorage.getItem(LS_SESSION) || ''; }
  function setSession(u){ if(u) localStorage.setItem(LS_SESSION, u); else localStorage.removeItem(LS_SESSION); }

  // --------- User Model ---------
  const defaultUserState = ()=>({
    username: '',
    password: '',
    balance: 0,
    coins: 0,
    cpc: 0.05,
    rebirths: 0,
    rebirthCost: 100_000_000_000, // increases ×100 each time
    upgrades: {}, // name -> level
    stats: {
      slots_spins: 0, slots_won: 0, slots_profit: 0,
      mines_plays: 0, mines_profit: 0,
      goals_plays: 0, goals_profit: 0,
    }
  });

  let users = loadUsers();
  let currentUser = null;
  let currentUsername = getSession();

  // --------- UI Refs ---------
  const balanceEl = qs('#balance');
  const coinsEl = qs('#coins');
  const cpcEl = qs('#cpc');
  const cpsEl = qs('#cps-indicator');

  // Menu
  const menuBtn = qs('#menu-btn');
  const menuDropdown = qs('#menu-dropdown');
  const panelLB = qs('#panel-leaderboard');
  const panelAdmin = qs('#panel-admin');
  const panelMoney = qs('#panel-money');

  // Tabs
  const tabs = qsa('nav.tabs button');
  const sections = qsa('section[role="tabpanel"]');

  // Clicker
  const bag = qs('#money-bag');      // NOTE: declared once (this was the bug)
  const upgradesWrap = qs('#upgrades');
  const rebirthBtn = qs('#rebirth-btn');
  const rebirthNeedEl = qs('#rebirth-need');
  const rebirthCostEl = qs('#rebirth-cost');

  // Slots
  const slotBet = qs('#slot-bet');
  const slotSpin = qs('#slot-spin');
  const slotReels = qs('#slot-reels');
  const slotMsg = qs('#slot-msg');

  // Mines
  const minesBet = qs('#mines-bet');
  const minesBombs = qs('#mines-bombs');
  const minesStart = qs('#mines-start');
  const minesCash = qs('#mines-cashout');
  const minesGrid = qs('#mines-grid');
  const minesGemsEl = qs('#mines-gems');
  const minesMultEl = qs('#mines-mult');
  const minesPotEl = qs('#mines-pot');

  // Goals
  const goalsBet = qs('#goals-bet');
  const goalsSize = qs('#goals-size');
  const goalsStart = qs('#goals-start');
  const goalsCash = qs('#goals-cashout');
  const goalsGrid = qs('#goals-grid');
  const goalsMultRow = qs('#goals-mult-row');
  const goalsColEl = qs('#goals-col');
  const goalsMultEl = qs('#goals-mult');
  const goalsPotEl = qs('#goals-pot');

  // Account
  const acctTabLogin = qs('#acct-tab-login');
  const acctTabRegister = qs('#acct-tab-register');
  const loginForm = qs('#login-form');
  const loginUser = qs('#login-user');
  const loginPass = qs('#login-pass');
  const loginBtn = qs('#login-btn');
  const regForm = qs('#reg-form');
  const regUser = qs('#reg-user');
  const regPass = qs('#reg-pass');
  const regPass2 = qs('#reg-pass2');
  const regBtn = qs('#reg-btn');
  const manualSaveBtn = qs('#manual-save');
  const acctStatus = qs('#acct-status');

  // Leaderboard
  const lbMoney = qs('#lb-money');
  const lbRebirths = qs('#lb-rebirths');
  const lbRefresh = qs('#lb-refresh');

  // Admin
  const adminLocked = qs('#admin-locked');
  const adminBody = qs('#admin-body');
  const adminPass = qs('#admin-pass');
  const adminLogin = qs('#admin-login');
  const adminLogout = qs('#admin-logout');
  const adminAccounts = qs('#admin-accounts');
  const adminResetAll = qs('#admin-reset-all');
  const adminRefresh = qs('#admin-refresh');
  const admUser = qs('#adm-user');
  const admBalance = qs('#adm-balance');
  const admSave = qs('#adm-save');
  const admGive = qs('#adm-give1k');
  const admWipe = qs('#adm-wipe');

  // Money
  const moneyFrom = qs('#money-from');
  const moneyTo = qs('#money-to');
  const moneyAmt = qs('#money-amount');
  const moneySend = qs('#money-send');

  // --------- Tabs behavior ---------
  tabs.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      tabs.forEach(b=>{
        b.classList.remove('active');
        b.setAttribute('aria-selected','false');
        const id = b.getAttribute('aria-controls');
        const sec = qs('#'+id);
        if(sec){ sec.classList.remove('active'); sec.style.display='none'; sec.setAttribute('aria-hidden','true'); }
      });
      btn.classList.add('active');
      btn.setAttribute('aria-selected','true');
      const id = btn.getAttribute('aria-controls');
      const sec = qs('#'+id);
      if(sec){ sec.classList.add('active'); sec.style.display=''; sec.setAttribute('aria-hidden','false'); }
    });
  });

  // --------- Dropdown menu ---------
  function toggleMenu(show){
    const will = (typeof show==='boolean') ? show : !menuDropdown.classList.contains('show');
    menuDropdown.classList.toggle('show', will);
    menuBtn.setAttribute('aria-expanded', will ? 'true':'false');
    menuDropdown.setAttribute('aria-hidden', will ? 'false':'true');
  }
  menuBtn.addEventListener('click', e=>{ e.stopPropagation(); toggleMenu(); });
  document.addEventListener('click', ()=>toggleMenu(false));

  // Menu items
  qs('#menu-leaderboard').addEventListener('click', ()=>{ renderLeaderboard(); openPanel(panelLB); });
  qs('#menu-admin').addEventListener('click', ()=> openPanel(panelAdmin));
  qs('#menu-money').addEventListener('click', ()=>{ populateMoney(); openPanel(panelMoney); });

  // --------- Panels ---------
  function openPanel(panel){ panel.classList.add('show'); panel.setAttribute('aria-hidden','false'); toggleMenu(false); }
  function closePanel(panel){ panel.classList.remove('show'); panel.setAttribute('aria-hidden','true'); }
  qsa('[data-close]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.getAttribute('data-close');
      const el = qs('#'+id);
      if(el) closePanel(el);
    });
  });
  [panelLB,panelAdmin,panelMoney].forEach(p=>{
    p.addEventListener('click', e=>{ if(e.target === p) closePanel(p); });
  });

  // --------- Game State (session-bound) ---------
  let balance = 0;
  let coins = 0;
  let cpc = 0.05;
  let rebirths = 0;
  let rebirthCost = 100_000_000_000;

  // --------- Autoclicker Limit: max 10 clicks/sec ---------
  let clickWindowStart = Date.now();
  let clickCountThisSec = 0;
  function canClick(){
    const now = Date.now();
    if(now - clickWindowStart >= 1000){
      clickWindowStart = now;
      clickCountThisSec = 0;
    }
    if(clickCountThisSec >= 10) return false;
    clickCountThisSec++;
    cpsEl.textContent = `${clickCountThisSec}/10 cps`;
    return true;
  }
  setInterval(()=>{
    const now = Date.now();
    if(now - clickWindowStart >= 1000){
      clickWindowStart = now;
      clickCountThisSec = 0;
      cpsEl.textContent = `0/10 cps`;
    }
  }, 150);

  // Upgrades catalog
  const upgradesCatalog = [
    {key:'Small Tip',        base:250,          inc:0.05},
    {key:'Wallet Upgrade',   base:50_000,       inc:0.10},
    {key:'Coin Press',       base:100_000,      inc:0.20},
    {key:'Gold Miner',       base:150_000,      inc:0.50},
    {key:'Bank Vault',       base:250_000,      inc:1},
    {key:'Fortune Wheel',    base:500_000,      inc:2},
    {key:'Money Factory',    base:1_000_000,    inc:3},
    {key:'Bitcoin Miner',    base:8_000_000,    inc:5},
    {key:'Diamond Mine',     base:50_000_000,   inc:10},
    {key:'Angel Investor',   base:500_000_000,  inc:20},
    {key:'Quantum Printer',  base:5_000_000_000,inc:40},
  ];
  function upgradeCost(key, level){
    const u = upgradesCatalog.find(x=>x.key===key);
    if(!u) return Infinity;
    return Math.floor(u.base * Math.pow(1.7, level));
  }

  // --------- UI Update Helpers ---------
  function refreshHUD(){
    balanceEl.textContent = fmt(balance);
    coinsEl.textContent = fmt(coins);
    cpcEl.textContent = cpc.toFixed(2);
    rebirthCostEl.textContent = numberFmt0(rebirthCost);
    updateRebirthButton();
    updateSlotControls();
    updateMinesNumbers();
    updateGoalsNumbers();
    buildUpgradesUI();
  }

  function updateRebirthButton(){
    const need = rebirthCost;
    const can = balance >= need;
    rebirthBtn.disabled = !can;
    rebirthBtn.setAttribute('aria-disabled', can ? 'false':'true');
    rebirthNeedEl.innerHTML = `Requires: $<span id="rebirth-cost">${numberFmt0(need)}</span>`;
  }

  // --------- Clicker ---------
  function buildUpgradesUI(){
    upgradesWrap.innerHTML = '';
    upgradesCatalog.forEach(row=>{
      const level = (currentUser?.upgrades?.[row.key] || 0);
      const cost = upgradeCost(row.key, level);
      const div = document.createElement('div');
      div.className = 'upgrade';
      if(cost > balance) div.classList.add('disabled');
      div.innerHTML = `
        <div class="name">${row.key}</div>
        <div class="info">${level>0 ? 'Level '+level : '—'}</div>
        <div class="cost">$${numberFmt0(cost)}</div>
      `;
      div.addEventListener('click', ()=>tryBuyUpgrade(row.key));
      div.addEventListener('keydown', e=>{
        if(e.key==='Enter' || e.key===' '){ e.preventDefault(); tryBuyUpgrade(row.key); }
      });
      div.setAttribute('tabindex', '0');
      upgradesWrap.appendChild(div);
    });
  }

  function tryBuyUpgrade(key){
    if(!currentUser){ toast('Login to buy upgrades'); return; }
    const level = (currentUser.upgrades[key] || 0);
    const cost = upgradeCost(key, level);
    if(balance < cost){ toast('Not enough balance'); return; }
    balance -= cost;
    currentUser.upgrades[key] = level + 1;
    const inc = (upgradesCatalog.find(u=>u.key===key)?.inc || 0);
    cpc = +(cpc + inc).toFixed(2);
    persistFromSession();
    refreshHUD();
    toast(`${key} upgraded to level ${level+1}`);
  }

  bag.addEventListener('click', ()=>{
    if(!canClick()) return;
    balance += cpc;
    coins += cpc;
    persistFromSession();
    refreshHUD();
  });
  bag.addEventListener('keydown', e=>{
    if(e.key==='Enter' || e.key===' '){ e.preventDefault(); bag.click(); }
  });

  rebirthBtn.addEventListener('click', ()=>{
    const need = rebirthCost;
    if(balance < need){ toast('Not enough to rebirth'); return; }
    if(!currentUser){ toast('Login to rebirth'); return; }
    balance = 0;
    coins = 0;
    cpc = +(cpc * 2).toFixed(2);
    rebirths += 1;
    rebirthCost = Math.floor(rebirthCost * 100);
    currentUser.rebirths = rebirths;
    currentUser.rebirthCost = rebirthCost;
    currentUser.upgrades = {};
    persistFromSession();
    refreshHUD();
    toast('Rebirth successful! CPC doubled, cost increased ×100.');
  });

  // --------- Slots ---------
  const slotSymbols = ['🍒','🍋','🍉','⭐','💎','7️⃣'];
  const slotWeights = [30,25,20,15,8,2];

  function slotWeighted(){
    const sum = slotWeights.reduce((a,b)=>a+b,0);
    let r = Math.random()*sum;
    for(let i=0;i<slotSymbols.length;i++){
      if(r < slotWeights[i]) return slotSymbols[i];
      r -= slotWeights[i];
    }
    return slotSymbols[0];
  }

  function updateSlotControls(){
    let v = Number(slotBet.value);
    if(!Number.isFinite(v) || v<50) v=50;
    if(v>balance) v = balance;
    slotBet.value = v;
    slotSpin.disabled = v<=0 || v>balance;
  }
  slotBet.addEventListener('input', updateSlotControls);

  slotSpin.addEventListener('click', ()=>{
    if(!currentUser){ toast('Login to play'); return; }
    let bet = Number(slotBet.value);
    if(bet>balance){ toast('Not enough balance'); return; }
    balance -= bet; updateSlotControls(); refreshHUD();
    slotMsg.textContent = '';
    slotSpin.disabled = true;

    // spin animation
    let steps=28, i=0;
    const timer = setInterval(()=>{
      slotReels.textContent = `${slotWeighted()} ${slotWeighted()} ${slotWeighted()}`;
      i++;
      if(i>=steps){
        clearInterval(timer);
        const [a,b,c] = slotReels.textContent.split(' ');
        const pay = slotPayout([a,b,c], bet);
        if(pay>0){
          balance += pay;
          currentUser.stats.slots_won++;
          currentUser.stats.slots_profit += (pay-bet);
          slotMsg.textContent = `You won $${fmt(pay)} 🎉`;
        }else{
          currentUser.stats.slots_profit -= bet;
          slotMsg.textContent = `No win, try again.`;
        }
        currentUser.stats.slots_spins++;
        persistFromSession();
        refreshHUD();
        slotSpin.disabled = false;
      }
    }, 50);
  });

  function slotPayout(res, bet){
    const [a,b,c] = res;
    if(a===b && b===c){
      switch(a){
        case '7️⃣': return bet*100;
        case '💎': return bet*50;
        case '⭐':  return bet*25;
        case '🍉': return bet*10;
        case '🍋': return bet*5;
        case '🍒': return bet*3;
      }
    }
    if(a===b || b===c || a===c) return bet*0.5;
    return 0;
  }

  // --------- Mines ---------
  const MINES_SIZE = 25; // 5x5
  let minesState = {
    playing:false,
    bet:10,
    bombs:1,
    bombSet:new Set(),
    gems:0,
    multipliers:[],
  };
  const minesMultTable = {
    1: [1.1,1.2,1.3,1.5,1.7,1.9,2.1,2.3,2.6,3,3.3,3.7,4.2,4.8,5.5,6.3,7.2,8.2,9.3,10.5],
    2: [1.3,1.5,1.7,1.9,2.2,2.5,3,3.5,4,4.5,5,5.7,6.5,7.5,8.5,9.7,11,12.5,14,16],
    3: [1.5,2,2.3,2.8,3.5,4.5,7,10,12,14,16,18,20,23,26,29,33,37,42,48],
  };

  function resetMinesGrid(){
    minesGrid.innerHTML = '';
    for(let i=0;i<MINES_SIZE;i++){
      const d = document.createElement('div');
      d.className = 'mines-cell';
      d.dataset.i = String(i);
      d.setAttribute('role','button');
      d.setAttribute('tabindex','0');
      d.addEventListener('click', ()=>revealMine(i));
      d.addEventListener('keydown', e=>{
        if(e.key==='Enter'||e.key===' '){ e.preventDefault(); revealMine(i); }
      });
      minesGrid.appendChild(d);
    }
  }
  resetMinesGrid();

  function updateMinesNumbers(){
    const m = minesState;
    const curMult = m.multipliers[m.gems] || 1;
    minesGemsEl.textContent = m.gems;
    minesMultEl.textContent = `${curMult.toFixed(2)}x`;
    const pot = m.playing ? (m.bet * curMult) : 0;
    minesPotEl.textContent = fmt(pot);
    minesStart.disabled = m.playing || !currentUser;
    minesCash.disabled = !m.playing || m.gems===0;
  }

  minesStart.addEventListener('click', ()=>{
    if(!currentUser){ toast('Login to play'); return; }
    const bet = clamp(Number(minesBet.value)||0, 1, balance);
    const bombs = Number(minesBombs.value)||1;
    if(bet<=0){ toast('Enter a valid bet'); return; }
    if(bet>balance){ toast('Not enough balance'); return; }
    balance -= bet;
    minesState = {
      playing:true, bet, bombs, gems:0,
      bombSet: new Set(),
      multipliers: minesMultTable[bombs].slice(0, 20)
    };
    while(minesState.bombSet.size < bombs){
      minesState.bombSet.add(Math.floor(Math.random()*MINES_SIZE));
    }
    qsa('.mines-cell', minesGrid).forEach(c=>{
      c.className='mines-cell';
      c.textContent='';
      c.style.pointerEvents='';
    });
    persistFromSession();
    updateMinesNumbers();
    refreshHUD();
  });

  function endMines(loss=false){
    if(!minesState.playing) return;
    if(loss){
      qsa('.mines-cell', minesGrid).forEach(c=>{
        const idx = Number(c.dataset.i);
        if(minesState.bombSet.has(idx)){
          c.classList.add('revealed','bomb');
          c.textContent = '💣';
        }
        c.style.pointerEvents='none';
      });
      currentUser.stats.mines_profit -= minesState.bet;
      toast('Boom! You lost the bet.');
    }
    minesState.playing = false;
    persistFromSession();
    updateMinesNumbers();
    refreshHUD();
  }

  function revealMine(i){
    if(!minesState.playing) return;
    const cell = qsa('.mines-cell', minesGrid)[i];
    if(cell.classList.contains('revealed')) return;
    if(minesState.bombSet.has(i)){
      cell.classList.add('revealed','bomb');
      cell.textContent='💣';
      endMines(true);
      return;
    }
    cell.classList.add('revealed','safe');
    cell.textContent='💎';
    minesState.gems++;
    currentUser.stats.mines_plays++;
    updateMinesNumbers();
    if(minesState.gems >= minesState.multipliers.length){
      minesCash.click(); // auto cashout at last step
    }
  }

  minesCash.addEventListener('click', ()=>{
    if(!minesState.playing) return;
    if(minesState.gems<=0){ toast('Find at least one gem to cash out'); return; }
    const mult = minesState.multipliers[minesState.gems] || 1;
    const win = minesState.bet * mult;
    balance += win;
    currentUser.stats.mines_profit += (win - minesState.bet);
    toast(`Cashed out $${fmt(win)}!`);
    endMines(false);
  });

  // --------- Goals ---------
  let goalsState = {
    playing:false,
    cols:7, rows:4,
    bet:10,
    col:0,
    bombs:[],
    mults:[],
  };

  function goalsMultForCols(cols){
    if(cols===7)  return [1.20,1.45,1.80,2.30,3.00,4.20,6.00];
    if(cols===10) return [1.15,1.30,1.55,1.90,2.35,2.90,3.70,4.80,6.20,8.20];
    const arr=[]; for(let i=1;i<=cols;i++){ arr.push(1+ i*0.2); } return arr;
  }

  function buildGoalsGrid(){
    goalsGrid.innerHTML='';
    goalsGrid.style.gridTemplateColumns = `repeat(${goalsState.cols}, 48px)`;
    goalsMultRow.innerHTML = '';
    goalsMultRow.style.gridTemplateColumns = `repeat(${goalsState.cols}, 48px)`;
    goalsState.mults.forEach((m, idx)=>{
      const tag = document.createElement('div');
      tag.className = 'goal-mult' + (idx===goalsState.col-1 ? ' active':'');
      tag.textContent = `${m.toFixed(2)}x`;
      goalsMultRow.appendChild(tag);
    });
    for(let r=0;r<goalsState.rows;r++){
      for(let c=0;c<goalsState.cols;c++){
        const d = document.createElement('div');
        d.className='goal';
        d.dataset.r=String(r);
        d.dataset.c=String(c);
        d.addEventListener('click', ()=>pickGoal(r,c));
        d.addEventListener('keydown', e=>{
          if(e.key==='Enter'||e.key===' '){ e.preventDefault(); pickGoal(r,c); }
        });
        d.setAttribute('role','button');
        d.setAttribute('tabindex','0');
        goalsGrid.appendChild(d);
      }
    }
  }

  function paintGoalsMultRow(){
    qsa('.goal-mult', goalsMultRow).forEach((el, idx)=>{
      el.classList.toggle('active', idx===goalsState.col-1);
    });
  }

  function updateGoalsNumbers(){
    if(!goalsState.playing){
      goalsColEl.textContent = '—';
      goalsMultEl.textContent = '—';
      goalsPotEl.textContent = fmt(0);
      goalsCash.disabled = true;
      return;
    }
    const cashIndex = Math.max(0, goalsState.col - 1);
    const cashMult = goalsState.col===0 ? 1 : (goalsState.mults[cashIndex] || 1);
    goalsColEl.textContent = String(goalsState.col)+'/'+goalsState.cols;
    goalsMultEl.textContent = `${cashMult.toFixed(2)}x`;
    goalsPotEl.textContent = fmt(goalsState.bet * cashMult);
    goalsCash.disabled = (goalsState.col === 0);
    paintGoalsMultRow();
  }

  function lockAllGoals(){
    qsa('.goal', goalsGrid).forEach(g=>g.style.pointerEvents='none');
  }
  function unlockColumn(col){
    qsa('.goal', goalsGrid).forEach(g=>{
      const c = Number(g.dataset.c);
      g.style.pointerEvents = (c===col) ? '' : 'none';
    });
  }

  goalsStart.addEventListener('click', ()=>{
    if(!currentUser){ toast('Login to play'); return; }
    const parts = goalsSize.value.split('x');
    const cols = Number(parts[0])||7;
    const rows = Number(parts[1])||4;
    const bet = clamp(Number(goalsBet.value)||0, 1, balance);
    if(bet<=0){ toast('Enter a valid bet'); return; }
    if(bet>balance){ toast('Not enough balance'); return; }

    balance -= bet;
    goalsState = {
      playing:true, cols, rows, bet,
      col:0, bombs:[], mults: goalsMultForCols(cols).slice(0, cols)
    };
    for(let c=0;c<cols;c++){
      goalsState.bombs[c] = Math.floor(Math.random()*rows);
    }
    buildGoalsGrid();
    lockAllGoals();
    unlockColumn(0);
    persistFromSession();
    updateGoalsNumbers();
    refreshHUD();
  });

  function endGoals(loss=false){
    if(!goalsState.playing) return;
    qsa('.goal', goalsGrid).forEach(g=>{
      const r = Number(g.dataset.r), c = Number(g.dataset.c);
      if(goalsState.bombs[c]===r && c<=goalsState.col){
        g.classList.add('revealed','bomb'); g.textContent='💥';
      }
      g.style.pointerEvents='none';
    });
    if(loss){
      currentUser.stats.goals_profit -= goalsState.bet;
      toast('Oh no! You hit a bomb.');
    }
    goalsState.playing=false;
    persistFromSession();
    updateGoalsNumbers();
    refreshHUD();
  }

  function pickGoal(r,c){
    if(!goalsState.playing) return;
    if(c !== goalsState.col) return;
    const cell = qsa('.goal', goalsGrid).find(d=>Number(d.dataset.r)===r && Number(d.dataset.c)===c);
    if(!cell || cell.classList.contains('revealed')) return;

    const bombR = goalsState.bombs[c];
    if(bombR === r){
      cell.classList.add('revealed','bomb');
      cell.textContent='💥';
      endGoals(true);
      return;
    }
    cell.classList.add('revealed','safe');
    cell.textContent='⭐';
    goalsState.col++;

    if(goalsState.col >= goalsState.cols){
      goalsCash.click();
      return;
    }
    unlockColumn(goalsState.col);
    updateGoalsNumbers();
  }

  goalsCash.addEventListener('click', ()=>{
    if(!goalsState.playing) return;
    if(goalsState.col <= 0){ toast('Pick at least one safe cell to cash out'); return; }
    const cashMult = goalsState.mults[goalsState.col-1] || 1;
    const win = goalsState.bet * cashMult;
    balance += win;
    currentUser.stats.goals_profit += (win - goalsState.bet);
    toast(`Cashed out $${fmt(win)}!`);
    endGoals(false);
  });

  // --------- Leaderboard ---------
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  function renderLeaderboard(){
    const money = Object.values(users).sort((a,b)=>b.balance - a.balance).slice(0,3);
    lbMoney.innerHTML='';
    if(!money.length){
      const d=document.createElement('div'); d.className='muted'; d.textContent='No accounts yet.'; lbMoney.appendChild(d);
    }else{
      money.forEach((u, idx)=>{
        const row = document.createElement('div');
        row.style.display='flex';
        row.style.justifyContent='space-between';
        row.style.alignItems='center';
        row.style.background='var(--btn)';
        row.style.border='1px solid rgba(255,255,255,.08)';
        row.style.borderRadius='10px';
        row.style.padding='8px 10px';
        row.innerHTML = `<div><b>${idx+1}.</b> ${escapeHtml(u.username)}</div><div><b>$${fmt(u.balance)}</b></div>`;
        lbMoney.appendChild(row);
      });
    }
    const reb = Object.values(users).sort((a,b)=> (b.rebirths||0) - (a.rebirths||0)).slice(0,3);
    lbRebirths.innerHTML='';
    if(!reb.length){
      const d=document.createElement('div'); d.className='muted'; d.textContent='No accounts yet.'; lbRebirths.appendChild(d);
    }else{
      reb.forEach((u, idx)=>{
        const row = document.createElement('div');
        row.style.display='flex';
        row.style.justifyContent='space-between';
        row.style.alignItems='center';
        row.style.background='var(--btn)';
        row.style.border='1px solid rgba(255,255,255,.08)';
        row.style.borderRadius='10px';
        row.style.padding='8px 10px';
        row.innerHTML = `<div><b>${idx+1}.</b> ${escapeHtml(u.username)}</div><div><b>${u.rebirths||0} rebirths</b></div>`;
        lbRebirths.appendChild(row);
      });
    }
  }
  lbRefresh.addEventListener('click', renderLeaderboard);

  // --------- Admin ---------
  const ADMIN_PASSCODE = '5113';

  const panelIds = ['panel-leaderboard','panel-admin','panel-money'];
  function openPanelById(id){
    const el = qs('#'+id);
    if(el) { el.classList.add('show'); el.setAttribute('aria-hidden', 'false'); }
  }

  adminLogin.addEventListener('click', ()=>{
    if(adminPass.value.trim() === ADMIN_PASSCODE){
      adminLocked.style.display='none';
      adminBody.style.display='';
      renderAdminAccounts();
      admUser.value = '';
      admBalance.value = '';
    }else{
      toast('Incorrect passcode');
    }
  });
  adminLogout.addEventListener('click', ()=>{
    adminBody.style.display='none';
    adminLocked.style.display='';
    adminPass.value='';
  });

  function renderAdminAccounts(){
    adminAccounts.innerHTML = '';
    const usernames = Object.keys(users).sort((a,b)=>a.localeCompare(b));
    if(!usernames.length){
      const d=document.createElement('div');
      d.className='muted';
      d.textContent='No users yet.';
      adminAccounts.appendChild(d);
      return;
    }
    usernames.forEach(u=>{
      const item = document.createElement('div');
      item.style.display='flex';
      item.style.alignItems='center';
      item.style.justifyContent='space-between';
      item.style.gap='8px';
      item.style.background='var(--btn)';
      item.style.border='1px solid rgba(255,255,255,.08)';
      item.style.borderRadius='10px';
      item.style.padding='8px';

      const left = document.createElement('div');
      left.innerHTML = `<b>${escapeHtml(u)}</b><div class="muted">$${fmt(users[u].balance)}</div>`;

      const right = document.createElement('div');
      right.style.display='flex';
      right.style.gap='6px';

      const eBtn = document.createElement('button');
      eBtn.className='btn text';
      eBtn.textContent='Edit';
      eBtn.addEventListener('click', ()=>{
        admUser.value = u;
        admBalance.value = users[u].balance.toString();
      });

      const wBtn = document.createElement('button');
      wBtn.className='btn';
      wBtn.style.background='var(--danger)';
      wBtn.style.color='#fff';
      wBtn.textContent='Wipe';
      wBtn.addEventListener('click', ()=>{
        if(confirm(`Wipe user "${u}"? This cannot be undone.`)){
          delete users[u];
          if(currentUsername===u){ currentUsername=''; currentUser=null; setSession(''); }
          saveUsers(users);
          renderAdminAccounts();
          renderLeaderboard();
          refreshHUD();
          toast('User wiped');
        }
      });

      right.appendChild(eBtn);
      right.appendChild(wBtn);
      item.appendChild(left);
      item.appendChild(right);
      adminAccounts.appendChild(item);
    });
  }

  adminRefresh.addEventListener('click', renderAdminAccounts);

  adminResetAll.addEventListener('click', ()=>{
    if(!confirm('Reset ALL progress for ALL users?')) return;
    Object.values(users).forEach(u=>{
      u.balance=0; u.coins=0; u.cpc=0.05; u.rebirths=0; u.upgrades={}; u.rebirthCost=100_000_000_000;
    });
    if(currentUser){
      balance=0; coins=0; cpc=0.05; rebirths=0; rebirthCost=100_000_000_000;
    }
    saveUsers(users);
    renderAdminAccounts();
    renderLeaderboard();
    refreshHUD();
    toast('All accounts reset');
  });

  admSave.addEventListener('click', ()=>{
    const u = admUser.value.trim();
    if(!u || !users[u]){ toast('Select a valid user'); return; }
    const val = Number(admBalance.value);
    if(!Number.isFinite(val) || val<0){ toast('Enter a valid balance'); return; }
    users[u].balance = val;
    if(currentUsername===u){ balance=val; }
    saveUsers(users);
    renderAdminAccounts();
    renderLeaderboard();
    refreshHUD();
    toast('Changes saved');
  });

  admGive.addEventListener('click', ()=>{
    const u = admUser.value.trim();
    if(!u || !users[u]){ toast('Select a valid user'); return; }
    users[u].balance += 1000;
    if(currentUsername===u){ balance += 1000; }
    saveUsers(users);
    renderAdminAccounts();
    renderLeaderboard();
    refreshHUD();
    toast('Gave +1,000');
  });

  admWipe.addEventListener('click', ()=>{
    const u = admUser.value.trim();
    if(!u || !users[u]){ toast('Select a valid user'); return; }
    if(!confirm(`Wipe user "${u}"?`)) return;
    delete users[u];
    if(currentUsername===u){ currentUsername=''; currentUser=null; setSession(''); }
    saveUsers(users);
    adminAccounts.innerHTML='';
    admUser.value=''; admBalance.value='';
    renderLeaderboard();
    refreshHUD();
    toast('User wiped');
  });

  // --------- Money (Transfers) ---------
  function populateMoney(){
    if(currentUser){
      moneyFrom.value = currentUser.username;
    }else{
      moneyFrom.value = '(not logged in)';
    }
    moneyTo.innerHTML = '';
    const usernames = Object.keys(users).sort((a,b)=>a.localeCompare(b));
    usernames.forEach(u=>{
      if(!currentUser || u!==currentUser.username){
        const opt = document.createElement('option');
        opt.value = u; opt.textContent = u;
        moneyTo.appendChild(opt);
      }
    });
  }

  moneySend.addEventListener('click', ()=>{
    if(!currentUser){ toast('Login to send money'); return; }
    const to = moneyTo.value;
    const amt = Number(moneyAmt.value);
    if(!to || !users[to]){ toast('Choose a recipient'); return; }
    if(!Number.isFinite(amt) || amt<=0){ toast('Enter valid amount'); return; }
    if(amt>balance){ toast('Not enough balance'); return; }
    if(to===currentUser.username){ toast('Cannot send to yourself'); return; }

    balance -= amt;
    users[to].balance += amt;
    saveUsers(users);
    persistFromSession();
    renderLeaderboard();
    refreshHUD();
    toast(`Sent $${fmt(amt)} to ${to}`);
    moneyAmt.value='';
  });

  // --------- Accounts ---------
  function setForms(mode){ // 'login' | 'register'
    if(mode==='login'){
      acctTabLogin.classList.add('active');
      acctTabRegister.classList.remove('active');
      loginForm.style.display='';
      regForm.style.display='none';
    }else{
      acctTabRegister.classList.add('active');
      acctTabLogin.classList.remove('active');
      loginForm.style.display='none';
      regForm.style.display='';
    }
  }
  acctTabLogin.addEventListener('click', ()=>setForms('login'));
  acctTabRegister.addEventListener('click', ()=>setForms('register'));

  loginBtn.addEventListener('click', ()=>{
    const u = loginUser.value.trim();
    const p = loginPass.value;
    if(!u || !p){ toast('Enter username and password'); return; }
    if(!users[u] || users[u].password !== p){ toast('Invalid credentials'); return; }
    currentUsername = u;
    currentUser = users[u];
    setSession(u);
    loadSessionFromUser();
    toast(`Welcome back, ${u}!`);
  });

  regBtn.addEventListener('click', ()=>{
    const u = regUser.value.trim();
    const p1 = regPass.value;
    const p2 = regPass2.value;
    if(!u || !p1 || !p2){ toast('Fill all fields'); return; }
    if(users[u]){ toast('Username already exists'); return; }
    if(p1!==p2){ toast('Passwords do not match'); return; }
    const newUser = defaultUserState();
    newUser.username = u;
    newUser.password = p1;
    users[u] = newUser;
    saveUsers(users);
    setForms('login');
    loginUser.value = u;
    toast('Account created. You can login now.');
  });

  manualSaveBtn.addEventListener('click', ()=>{
    if(currentUser){
      persistFromSession();
      toast('Saved.');
    }else{
      toast('Login to save');
    }
  });

  function persistFromSession(){
    if(!currentUser) return;
    currentUser.balance = balance;
    currentUser.coins = coins;
    currentUser.cpc = cpc;
    currentUser.rebirths = rebirths;
    currentUser.rebirthCost = rebirthCost;
    users[currentUser.username] = currentUser;
    saveUsers(users);
    updateAcctStatus();
  }

  function loadSessionFromUser(){
    if(!currentUser) return;
    balance = currentUser.balance || 0;
    coins = currentUser.coins || 0;
    cpc = currentUser.cpc || 0.05;
    rebirths = currentUser.rebirths || 0;
    rebirthCost = currentUser.rebirthCost || 100_000_000_000;
    refreshHUD();
    updateAcctStatus();
  }

  function updateAcctStatus(){
    if(currentUser){
      acctStatus.textContent = `Logged in as ${currentUser.username} — Rebirths: ${currentUser.rebirths||0}`;
    }else{
      acctStatus.textContent = 'Not logged in';
    }
  }

  // Auto-save every 60s
  setInterval(()=>{ if(currentUser) persistFromSession(); }, 60_000);

  // --------- Gambling sub-tabs ---------
  const gtSlot = qs('#gt-slot');
  const gtMines = qs('#gt-mines');
  const gtGoals = qs('#gt-goals');
  const slotPane = qs('#slot-machine');
  const minesPane = qs('#mines');
  const goalsPane = qs('#goals');

  function showGame(btn){
    [gtSlot,gtMines,gtGoals].forEach(b=>{ b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
    [slotPane,minesPane,goalsPane].forEach(p=>p.style.display='none');

    btn.classList.add('active');
    btn.setAttribute('aria-selected','true');
    if(btn===gtSlot) slotPane.style.display='block';
    if(btn===gtMines) minesPane.style.display='block';
    if(btn===gtGoals) goalsPane.style.display='block';
  }
  gtSlot.addEventListener('click', ()=>showGame(gtSlot));
  gtMines.addEventListener('click', ()=>showGame(gtMines));
  gtGoals.addEventListener('click', ()=>showGame(gtGoals));

  // --------- Init ---------
  function buildUpgradesIfEmpty(){ if(!upgradesWrap.childElementCount) buildUpgradesUI(); }

  function firstRun(){
    if(currentUsername && users[currentUsername]){
      currentUser = users[currentUsername];
      loadSessionFromUser();
    }else{
      currentUser = null;
      updateAcctStatus();
      refreshHUD();
    }
    buildUpgradesIfEmpty();
    renderLeaderboard();
    updateSlotControls();
    updateMinesNumbers();
    buildGoalsGrid();
    updateGoalsNumbers();
  }
  firstRun();
  </script>
</body>
</html>
